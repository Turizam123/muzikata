<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UZIMUZIK ‚Äî Studio Neon</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070812;
      --panel:#0c0f22cc;
      --border:#2a2f55;
      --text:#e8ebff;
      --muted:#aab0dd;
      --neon1:#7c4dff;
      --neon2:#00e5ff;
      --danger:#ff3d71;
      --ok:#00d68f;
      --shadow: 0 10px 40px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(124,77,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(0,229,255,.14), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(255,61,113,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:9;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,8,18,.92), rgba(7,8,18,.65));
      border-bottom:1px solid rgba(42,47,85,.6);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
    .brand{
      display:flex;align-items:center;gap:12px;
      font-family:Orbitron,Inter;
      letter-spacing:.08em;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(0,229,255,.9), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(124,77,255,.9), transparent 55%),
        rgba(12,15,34,.9);
      border:1px solid rgba(42,47,85,.9);
      box-shadow: 0 0 25px rgba(0,229,255,.18), 0 0 35px rgba(124,77,255,.14);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: var(--panel);
      border:1px solid rgba(42,47,85,.75);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-family:Orbitron,Inter;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding:14px 16px;
      border-bottom:1px solid rgba(42,47,85,.55);
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .hint{color:var(--muted);font-size:12px;font-family:Inter;letter-spacing:0;text-transform:none}
    .content{padding:14px 16px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(42,47,85,.8);
      background: rgba(7,8,18,.35);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .neon-line{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(0,229,255,.7), rgba(124,77,255,.7), transparent);
      opacity:.75;
    }
    .posts{
      display:flex;flex-direction:column;gap:12px;
    }
    .post{
      border:1px solid rgba(42,47,85,.6);
      border-radius: 16px;
      background: rgba(7,8,18,.38);
      overflow:hidden;
    }
    .post .meta{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px 8px 12px;
    }
    .title{font-weight:600}
    .sub{color:var(--muted);font-size:12px}
    audio, video{width:100%; display:block; background:#000}
    video{max-height:360px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, textarea, button, select{
      font: inherit;
    }
    .field{
      width:100%;
      background: rgba(7,8,18,.45);
      border:1px solid rgba(42,47,85,.8);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
    }
    textarea.field{min-height:92px;resize:vertical}
    .btn{
      border:1px solid rgba(42,47,85,.8);
      background: linear-gradient(180deg, rgba(124,77,255,.25), rgba(7,8,18,.25));
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform: translateY(1px)}
    .btn2{
      background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(7,8,18,.25));
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,61,113,.22), rgba(7,8,18,.25));
    }
    .toast{
      position:fixed; left:16px; bottom:16px; z-index:99;
      background: rgba(12,15,34,.92);
      border:1px solid rgba(42,47,85,.85);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
      max-width:min(520px, calc(100vw - 32px));
    }
    .toast strong{font-family:Orbitron}
    .comments{
      display:flex;flex-direction:column;gap:10px;
      max-height: 420px;
      overflow:auto;
      padding-right:4px;
    }
    .c{
      border:1px solid rgba(42,47,85,.55);
      border-radius: 14px;
      background: rgba(7,8,18,.35);
      padding:10px 10px;
    }
    .cTop{display:flex;justify-content:space-between;gap:10px}
    .cName{font-weight:600}
    .cTime{color:var(--muted);font-size:12px;white-space:nowrap}
    .cTxt{margin-top:6px;white-space:pre-wrap;word-break:break-word}
    .shareBox{
      display:flex;gap:10px;flex-wrap:wrap
    }
    a.link{
      color:var(--text);
      text-decoration:none;
    }
    a.link:hover{text-decoration:underline}
  </style>

  <!-- Facebook SDK -->
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/bg_BG/sdk.js#xfbml=1&version=v21.0">
  </script>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-size:16px;font-weight:600;">UZIMUZIK</div>
          <div style="color:var(--muted);font-size:12px;">Neon studio page ‚Ä¢ music + clips ‚Ä¢ live comments</div>
        </div>
      </div>
    </div>
    <div class="neon-line"></div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: Posts -->
      <section class="card">
        <h2>
          –ú–æ—è—Ç–∞ –º—É–∑–∏–∫–∞ –∏ –∫–ª–∏–ø–æ–≤–µ
          <span class="pill" id="postsCount">0</span>
        </h2>
        <div class="content">
          <div class="row" style="justify-content:space-between;margin-bottom:10px;">
            <div class="hint">–ü–ª–µ–π–ª–∏—Å—Ç –æ—Ç Supabase</div>
            <button class="btn btn2" id="reloadPostsBtn">–ü—Ä–µ–∑–∞—Ä–µ–¥–∏</button>
          </div>

          <div class="posts" id="posts"></div>

          <div style="margin-top:14px;" class="hint">
            ‚ö†Ô∏è –ö–∞—á–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ –æ–±–∏–∫–Ω–æ–≤–µ–Ω–æ –µ ‚Äúadmin-only‚Äù. –ê–∫–æ –∏—Å–∫–∞—à, —â–µ –¥–æ–±–∞–≤—è –æ—Ç–¥–µ–ª–µ–Ω admin –ø–∞–Ω–µ–ª/–ø–∞—Ä–æ–ª–∞.
          </div>
        </div>
      </section>

      <!-- RIGHT: Live comments + FB + TikTok -->
      <aside class="card">
        <h2>
          Live –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ (7 –¥–Ω–∏)
          <span class="pill" id="commentsCount">0</span>
        </h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px;">
            <input class="field" id="username" placeholder="–ò–º–µ (–ø—Ä–∏–º–µ—Ä: Angel)" maxlength="40" />
          </div>
          <div class="row" style="margin-bottom:10px;">
            <textarea class="field" id="comment" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä..." maxlength="500"></textarea>
          </div>
          <div class="row" style="justify-content:space-between;margin-bottom:10px;">
            <button class="btn" id="sendBtn">–ü—É–±–ª–∏–∫—É–≤–∞–π</button>
            <button class="btn btnDanger" id="cleanupBtn" title="–¢—Ä–∏–µ —Å–∞–º–æ –ø–æ-—Å—Ç–∞—Ä–∏ –æ—Ç 7 –¥–Ω–∏">–ü–æ—á–∏—Å—Ç–∏ (7+ –¥–Ω–∏)</button>
          </div>

          <div class="comments" id="comments"></div>

          <div style="margin-top:14px;">
            <div class="neon-line" style="margin:12px 0;"></div>

            <div class="row" style="justify-content:space-between;align-items:flex-end;">
              <div>
                <div style="font-family:Orbitron;letter-spacing:.12em;text-transform:uppercase;font-size:12px;">
                  Facebook –∫–æ–º–µ–Ω—Ç–∞—Ä–∏
                </div>
                <div class="hint">–¢–æ–≤–∞ —Å–∞ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏ FB –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ (–æ—Ç Facebook –ø—Ä–æ—Ñ–∏–ª–∏).</div>
              </div>
            </div>

            <!-- data-href: —Å–ª–æ–∂–∏ URL –Ω–∞ —Ç–≤–æ—è—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
            <div class="fb-comments"
              data-href=""
              data-width="100%"
              data-numposts="5"></div>

            <div class="neon-line" style="margin:12px 0;"></div>

            <div style="font-family:Orbitron;letter-spacing:.12em;text-transform:uppercase;font-size:12px;">
              TikTok —Å–ø–æ–¥–µ–ª—è–Ω–µ
            </div>
            <div class="hint" style="margin:6px 0 10px;">
              TikTok –Ω–µ –¥–∞–≤–∞ –ø—É–±–ª–∏—á–µ–Ω embed –∑–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏. –ú–æ–∂–µ–º –¥–∞ –¥–æ–±–∞–≤–∏–º share + –ª–∏–Ω–∫–æ–≤–µ –∫—ä–º TikTok –∫–ª–∏–ø–æ–≤–µ—Ç–µ —Ç–∏.
            </div>

            <div class="shareBox">
              <a class="btn link" id="tiktokShare" href="#" target="_blank" rel="noreferrer">–°–ø–æ–¥–µ–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –≤ TikTok</a>
              <a class="btn btn2 link" id="copyLink" href="#">–ö–æ–ø–∏—Ä–∞–π –ª–∏–Ω–∫</a>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Supabase JS -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ‚úÖ –í–™–í–ï–î–ò –¢–í–û–ò–¢–ï –î–ê–ù–ù–ò:
    const SUPABASE_URL = "PASTE_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY_HERE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elPosts = document.getElementById("posts");
    const elPostsCount = document.getElementById("postsCount");
    const elComments = document.getElementById("comments");
    const elCommentsCount = document.getElementById("commentsCount");
    const elUsername = document.getElementById("username");
    const elComment = document.getElementById("comment");
    const toast = document.getElementById("toast");

    // ===== Helpers =====
    const fmtTime = (iso) => {
      const d = new Date(iso);
      return d.toLocaleString("bg-BG", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    };

    const showToast = (html, ms=2600) => {
      toast.innerHTML = html;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.style.display = "none", ms);
    };

    const escapeHtml = (s) =>
      s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    // ===== Posts =====
    async function loadPosts(){
      elPosts.innerHTML = "";
      const { data, error } = await supabase
        .from("music_posts")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(30);

      if(error){
        showToast(`<strong>–ì—Ä–µ—à–∫–∞:</strong> ${escapeHtml(error.message)}`, 4200);
        return;
      }

      elPostsCount.textContent = data.length;

      if(data.length === 0){
        elPosts.innerHTML = `<div class="hint">–û—â–µ –Ω—è–º–∞ –∫–∞—á–µ–Ω–∏ –ø–µ—Å–Ω–∏/–∫–ª–∏–ø–æ–≤–µ.</div>`;
        return;
      }

      for(const p of data){
        const wrap = document.createElement("div");
        wrap.className = "post";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <div>
            <div class="title">${escapeHtml(p.title)}</div>
            <div class="sub">${escapeHtml(p.type.toUpperCase())} ‚Ä¢ ${fmtTime(p.created_at)}</div>
          </div>
          <span class="pill">${escapeHtml(p.type)}</span>
        `;

        wrap.appendChild(meta);

        if(p.type === "audio"){
          const a = document.createElement("audio");
          a.controls = true;
          a.preload = "none";
          a.src = p.media_url;
          wrap.appendChild(a);
        } else {
          const v = document.createElement("video");
          v.controls = true;
          v.preload = "none";
          v.src = p.media_url;
          wrap.appendChild(v);
        }

        elPosts.appendChild(wrap);
      }
    }

    // ===== Comments =====
    async function cleanupOldComments(){
      // –¢—Ä–∏–µ —Å–∞–º–æ –ø–æ-—Å—Ç–∞—Ä–∏ –æ—Ç 7 –¥–Ω–∏ (RLS policy –≥–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞)
      const cutoff = new Date(Date.now() - 7*24*60*60*1000).toISOString();
      const { error } = await supabase
        .from("live_comments")
        .delete()
        .lt("created_at", cutoff);

      if(error){
        showToast(`<strong>Cleanup:</strong> ${escapeHtml(error.message)}`, 4200);
      } else {
        showToast(`<strong>Cleanup:</strong> –∏–∑—Ç–µ–∫–ª–∏—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ —Å–∞ –ø–æ—á–∏—Å—Ç–µ–Ω–∏ ‚úÖ`);
      }
    }

    async function loadComments(){
      elComments.innerHTML = "";
      const cutoff = new Date(Date.now() - 7*24*60*60*1000).toISOString();

      const { data, error } = await supabase
        .from("live_comments")
        .select("*")
        .gte("created_at", cutoff)
        .order("created_at", { ascending: false })
        .limit(80);

      if(error){
        showToast(`<strong>–ì—Ä–µ—à–∫–∞:</strong> ${escapeHtml(error.message)}`, 4200);
        return;
      }

      elCommentsCount.textContent = data.length;

      if(data.length === 0){
        elComments.innerHTML = `<div class="hint">–û—â–µ –Ω—è–º–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 7 –¥–Ω–∏. –ë—ä–¥–∏ –ø—ä—Ä–≤–∏—è—Ç üôÇ</div>`;
        return;
      }

      for(const c of data){
        renderComment(c, { prepend: false });
      }
    }

    function renderComment(c, { prepend=true } = {}){
      const box = document.createElement("div");
      box.className = "c";
      box.innerHTML = `
        <div class="cTop">
          <div class="cName">${escapeHtml(c.username)}</div>
          <div class="cTime">${fmtTime(c.created_at)}</div>
        </div>
        <div class="cTxt">${escapeHtml(c.comment)}</div>
      `;
      if(prepend) elComments.prepend(box);
      else elComments.appendChild(box);
    }

    async function sendComment(){
      const username = (elUsername.value || "").trim();
      const comment = (elComment.value || "").trim();

      if(username.length < 1){
        showToast(`<strong>–õ–∏–ø—Å–≤–∞ –∏–º–µ:</strong> –≤—ä–≤–µ–¥–∏ –∏–º–µ.`, 2600);
        return;
      }
      if(comment.length < 1){
        showToast(`<strong>–ü—Ä–∞–∑–µ–Ω –∫–æ–º–µ–Ω—Ç–∞—Ä:</strong> –Ω–∞–ø–∏—à–∏ –Ω–µ—â–æ.`, 2600);
        return;
      }

      const { error } = await supabase
        .from("live_comments")
        .insert({ username, comment });

      if(error){
        showToast(`<strong>–ì—Ä–µ—à–∫–∞:</strong> ${escapeHtml(error.message)}`, 4200);
        return;
      }

      elComment.value = "";
      showToast(`<strong>–ü—É–±–ª–∏–∫—É–≤–∞–Ω–æ ‚úÖ</strong>`, 1600);
    }

    // ===== Realtime subscription =====
    function bindRealtime(){
      supabase
        .channel("live_comments_feed")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "live_comments" },
          (payload) => {
            // –ø–æ–∫–∞–∑–≤–∞–º–µ –Ω–æ–≤–æ—Ç–æ –≤–µ–¥–Ω–∞–≥–∞
            const c = payload.new;
            renderComment(c, { prepend: true });

            // –æ–±–Ω–æ–≤–∏ –±—Ä–æ—è (–±–µ–∑ –¥–∞ –ø—Ä–∞–≤–∏–º —Ç–µ–∂–∫–æ query)
            elCommentsCount.textContent = (Number(elCommentsCount.textContent||"0") + 1).toString();
          }
        )
        .subscribe((status) => {
          if(status === "SUBSCRIBED"){
            showToast(`<strong>Realtime:</strong> —Å–≤—ä—Ä–∑–∞–Ω ‚úÖ`, 1400);
          }
        });
    }

    // ===== TikTok share + copy link =====
    function setupShare(){
      const pageUrl = window.location.href;
      const shareUrl = "https://www.tiktok.com/share?url=" + encodeURIComponent(pageUrl);
      const tiktokShare = document.getElementById("tiktokShare");
      const copyLink = document.getElementById("copyLink");

      tiktokShare.href = shareUrl;

      copyLink.addEventListener("click", async (e) => {
        e.preventDefault();
        try{
          await navigator.clipboard.writeText(pageUrl);
          showToast(`<strong>–õ–∏–Ω–∫:</strong> –∫–æ–ø–∏—Ä–∞–Ω ‚úÖ`, 1600);
        } catch {
          showToast(`<strong>–õ–∏–Ω–∫:</strong> –Ω–µ —É—Å–ø—è—Ö –¥–∞ –∫–æ–ø–∏—Ä–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.`, 2600);
        }
      });

      // Facebook comments: data-href –¥–∞ –µ —Ç–µ–∫—É—â–∏—è URL
      const fb = document.querySelector(".fb-comments");
      if(fb) fb.setAttribute("data-href", pageUrl);
    }

    // ===== UI events =====
    document.getElementById("sendBtn").addEventListener("click", sendComment);
    document.getElementById("cleanupBtn").addEventListener("click", cleanupOldComments);
    document.getElementById("reloadPostsBtn").addEventListener("click", loadPosts);

    // Enter = –ø—É–±–ª–∏–∫—É–≤–∞–Ω–µ (Ctrl+Enter –∑–∞ textarea)
    elComment.addEventListener("keydown", (e) => {
      if((e.ctrlKey || e.metaKey) && e.key === "Enter") sendComment();
    });

    // ===== Boot =====
    (async function init(){
      setupShare();

      // 1) —á–∏—Å—Ç–∏–º –∏–∑—Ç–µ–∫–ª–∏—Ç–µ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)
      await cleanupOldComments();

      // 2) –∑–∞—Ä–µ–∂–¥–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ
      await loadPosts();
      await loadComments();

      // 3) realtime
      bindRealtime();
    })();
  </script>
</body>
</html>
